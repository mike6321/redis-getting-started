# Transactions

Redis의 Transactions 기능에 대해 학습합니다. Redis 트랜잭션은 명령어들을 원자적으로 실행할 수 있게 해줍니다.

## 특징

- 여러 명령어를 하나의 원자적 단위로 실행
- 트랜잭션 중에는 다른 클라이언트의 요청이 끼어들 수 없음
- All-or-Nothing 실행이 아닌, 개별 명령어 단위로 오류 처리
- WATCH를 통한 낙관적 잠금 지원

## 주요 명령어

- **MULTI**: 트랜잭션 시작
- **EXEC**: 트랜잭션 실행
- **DISCARD**: 트랜잭션 취소
- **WATCH**: 키 변경 감시 (낙관적 잠금)

## 실습 예제

### 기본 트랜잭션

```sh
# 트랜잭션 시작
127.0.0.1:6379> multi
OK

# 명령어들이 큐에 저장됨
127.0.0.1:6379(TX)> set key1 100
QUEUED
127.0.0.1:6379(TX)> set key2 200
QUEUED

# 트랜잭션 실행
127.0.0.1:6379(TX)> exec
1) OK
2) OK
```

### 트랜잭션 취소

```sh
# 트랜잭션 시작
127.0.0.1:6379> multi
OK
127.0.0.1:6379(TX)> set key1 100
QUEUED
127.0.0.1:6379(TX)> set key2 200
QUEUED

# 트랜잭션 취소
127.0.0.1:6379(TX)> discard
OK
```

### 오류 처리

```sh
# 문법 오류가 있는 트랜잭션
127.0.0.1:6379> multi
OK
127.0.0.1:6379(TX)> set key1 100
QUEUED
127.0.0.1:6379(TX)> set key1 100 200  # 잘못된 문법
QUEUED
127.0.0.1:6379(TX)> set key2 200
QUEUED

# 실행 시 개별 명령어별로 오류 처리
127.0.0.1:6379(TX)> exec
1) OK
2) (error) ERR syntax error
3) OK

# 성공한 명령어는 실행됨
127.0.0.1:6379> get key1
"100"
```

### WATCH를 이용한 낙관적 잠금

```sh
# 키 감시 시작
127.0.0.1:6379> watch key1
OK

# 트랜잭션 시작
127.0.0.1:6379> multi
OK
127.0.0.1:6379(TX)> set key1 100
QUEUED
127.0.0.1:6379(TX)> set key2 200
QUEUED
127.0.0.1:6379(TX)> set key3 300
QUEUED

# 다른 클라이언트에서 감시 중인 키 변경
# >>> 127.0.0.1:6379> set key1 999

# 트랜잭션 실행 시 실패 (키가 변경되었기 때문)
127.0.0.1:6379(TX)> exec
(nil)
```

## 활용 사례

- 계좌 잔고 업데이트 (동시성 제어)
- 카운터 증가 시 일관성 보장
- 복합 데이터 업데이트
- 조건부 실행 (WATCH와 함께)

